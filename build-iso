#!/bin/bash

# Visual helpers
BOLD='\033[1m'
RESET='\033[0m'
step() { echo -e "${BOLD}==> $1${RESET}" && eval "$2"; }

build() {
  step "Creating build workspace..." "mkdir -p /tmp/isobuild"
  
  # 1. Install archiso tools
  step "Installing archiso..." "pacman -Syu --noconfirm archiso"
  
  # 2. Copy the default releng profile
  step "Copying releng profile..." "cp -r /usr/share/archiso/configs/releng/* /tmp/isobuild"
  
  # 3. Add Custom Packages
  step "Adding custom packages..." "cat custom-packages.txt >> /tmp/isobuild/packages.x86_64"
  
  # 4. Copy Custom Files (Recursive copy of our 'custom' folder)
  step "Copying custom configurations..." "cp -r custom/airootfs/* /tmp/isobuild/airootfs/"
  
  # 5. Set Permissions
  step "Setting permissions..." "
    chmod +x /tmp/isobuild/airootfs/usr/local/bin/setup-live-user.sh
    chmod 440 /tmp/isobuild/airootfs/etc/sudoers.d/live-user
  "
  
  # 6. Enable Services (Symlinks)
  step "Enabling Systemd Services..." "
    # Create wants directory
    mkdir -p /tmp/isobuild/airootfs/etc/systemd/system/multi-user.target.wants
    
    # Enable NetworkManager (disable systemd-networkd if it conflicts, but usually fine)
    ln -sf /usr/lib/systemd/system/NetworkManager.service \
       /tmp/isobuild/airootfs/etc/systemd/system/multi-user.target.wants/
       
    # Enable User Setup Service
    ln -sf /etc/systemd/system/live-user-setup.service \
       /tmp/isobuild/airootfs/etc/systemd/system/multi-user.target.wants/
  "

  # 7. Build
  step "Building ISO (This will take time)..." "mkarchiso -v -w work/ -o ./ /tmp/isobuild"
  
  # 8. Checksums
  ISO_NAME=$(ls | grep "archlinux-.*-x86_64.iso" | head -n1)
  step "Generating checksums..." "
    b2sum $ISO_NAME > CHECKSUMS.txt
    sha256sum $ISO_NAME >> CHECKSUMS.txt
  "
}

if [ -z ${DATE+x} ]; then
  echo "DATE variable not set! (Run via Github Actions)" && exit 1
else
  build
fi
